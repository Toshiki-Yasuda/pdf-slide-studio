<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>PDF Slide Studio Pro v4 - ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»ï¼†å†é…ç½®</title>
  <meta name="description" content="PDFã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¶ˆå»ã—ã€ç·¨é›†å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§å†é…ç½®ã€‚å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã®PPTXå‡ºåŠ›ã€‚">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    @keyframes aurora-1 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } }
    @keyframes aurora-2 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-20px, 10px) scale(1.2); } }
    .animate-aurora-1 { animation: aurora-1 10s infinite ease-in-out; }
    .animate-aurora-2 { animation: aurora-2 12s infinite ease-in-out; }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }
    
    .touch-feedback:active { transform: scale(0.98); opacity: 0.9; }
    
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    
    .progress-ring { transform: rotate(-90deg); }
    
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .tab-active { background: rgba(6, 182, 212, 0.2); border-color: rgb(6, 182, 212); color: rgb(6, 182, 212); }
    
    .text-block-overlay { position: absolute; border: 2px solid; pointer-events: none; }
  </style>

</head>
<body class="bg-slate-950 text-slate-200 min-h-screen">

  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/20 rounded-full blur-[100px] animate-aurora-1"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/20 rounded-full blur-[100px] animate-aurora-2"></div>
  </div>

  <div id="app" class="relative z-10 min-h-screen p-4 md:p-6">
    <div class="w-full max-w-7xl mx-auto space-y-6">

```
  <!-- Header -->
  <header class="text-center space-y-3 pt-2">
    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10">
      <i data-lucide="sparkles" class="w-3.5 h-3.5 text-cyan-300"></i>
      <span class="text-[10px] uppercase tracking-widest font-bold text-cyan-300">PDF Slide Studio Pro v4</span>
    </div>
    
    <div id="header-content">
      <h1 class="text-2xl md:text-4xl font-extrabold text-white">ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»ï¼†å†é…ç½®</h1>
      <p class="text-slate-400 text-sm max-w-xl mx-auto mt-2">
        å…ƒç”»åƒã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¶ˆå»ã—ã€ç·¨é›†å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§å†é…ç½®ã€‚å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã®PPTXã€‚
      </p>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Upload Area -->
    <div id="upload-area" class="bg-white/5 backdrop-blur-2xl rounded-2xl border border-white/10 overflow-hidden">
      <input type="file" id="file-input" class="hidden" accept="application/pdf,.pdf">
      
      <button type="button" id="upload-button" class="w-full p-8 md:p-12 text-center cursor-pointer group hover:bg-white/5 transition-all touch-feedback">
        <div class="flex flex-col items-center gap-4">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center bg-slate-800/50 text-cyan-300">
            <i data-lucide="file-text" class="w-8 h-8"></i>
          </div>
          <div>
            <p class="text-xl font-bold text-slate-200">PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <p class="text-xs text-slate-500 mt-1">ã‚¿ãƒƒãƒ—ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
          </div>
          
          <!-- Settings -->
          <div class="w-full max-w-md mt-4 space-y-3">
            
            <!-- OCR -->
            <div class="p-3 bg-slate-900/50 rounded-xl border border-slate-700/50">
              <h4 class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                <i data-lucide="scan-text" class="w-3.5 h-3.5"></i>OCRè¨­å®š
              </h4>
              <div class="flex flex-wrap gap-2 justify-center">
                <select id="ocr-language" class="bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-1.5 text-xs text-slate-300">
                  <option value="jpn+eng">æ—¥æœ¬èª+è‹±èª</option>
                  <option value="jpn">æ—¥æœ¬èªã®ã¿</option>
                  <option value="eng">è‹±èªã®ã¿</option>
                </select>
              </div>
            </div>
            
            <!-- Text Erase Settings -->
            <div class="p-3 bg-slate-900/50 rounded-xl border border-slate-700/50">
              <h4 class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                <i data-lucide="eraser" class="w-3.5 h-3.5"></i>ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»è¨­å®š
              </h4>
              <div class="space-y-2">
                <label class="flex items-center justify-between">
                  <span class="text-xs text-slate-400">æ¶ˆå»ãƒãƒ¼ã‚¸ãƒ³ï¼ˆpxï¼‰</span>
                  <div class="flex items-center gap-2">
                    <input type="range" id="erase-margin" min="0" max="20" value="5" class="w-16 h-2">
                    <span id="erase-margin-value" class="text-xs text-slate-300 w-6">5px</span>
                  </div>
                </label>
                <label class="flex items-center justify-between">
                  <span class="text-xs text-slate-400">æœ€å°ä¿¡é ¼åº¦</span>
                  <div class="flex items-center gap-2">
                    <input type="range" id="min-confidence" min="30" max="90" value="50" class="w-16 h-2">
                    <span id="min-confidence-value" class="text-xs text-slate-300 w-8">50%</span>
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Font Settings -->
            <div class="p-3 bg-slate-900/50 rounded-xl border border-slate-700/50">
              <h4 class="text-xs font-bold text-slate-300 mb-2 flex items-center gap-2">
                <i data-lucide="type" class="w-3.5 h-3.5"></i>ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
              </h4>
              <div class="space-y-2">
                <label class="flex items-center justify-between">
                  <span class="text-xs text-slate-400">ãƒ•ã‚©ãƒ³ãƒˆ</span>
                  <select id="font-family" class="bg-slate-800/50 border border-slate-700 rounded px-2 py-1 text-xs text-slate-300">
                    <option value="Meiryo">ãƒ¡ã‚¤ãƒªã‚ª</option>
                    <option value="Yu Gothic">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                    <option value="MS PGothic">MS Pã‚´ã‚·ãƒƒã‚¯</option>
                    <option value="Hiragino Sans">ãƒ’ãƒ©ã‚®ãƒè§’ã‚´</option>
                    <option value="Arial">Arial</option>
                  </select>
                </label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="auto-bold" checked class="w-3.5 h-3.5 rounded text-cyan-500">
                  <span class="text-xs text-slate-400">å¤§ãã„æ–‡å­—ã‚’å¤ªå­—ã«</span>
                </label>
              </div>
            </div>
          </div>
          
          <div class="mt-2 px-6 py-3 bg-cyan-600 hover:bg-cyan-700 text-white rounded-xl font-medium text-sm transition-all shadow-lg flex items-center gap-2">
            <i data-lucide="folder-open" class="w-5 h-5"></i>
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          </div>
          
          <div id="init-status" class="inline-flex items-center gap-2 px-3 py-1.5 bg-black/20 text-slate-400 text-xs rounded-full mt-2">
            <i data-lucide="loader-2" class="w-3 h-3 animate-spin text-cyan-400"></i>
            <span>OCRã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™ä¸­...</span>
          </div>
        </div>
      </button>
    </div>

    <!-- Processing -->
    <div id="processing-area" class="hidden bg-white/5 backdrop-blur-2xl rounded-2xl border border-white/10 p-12 flex-col items-center justify-center min-h-[350px]">
      <div class="relative w-32 h-32 mb-6">
        <svg class="w-full h-full progress-ring" viewBox="0 0 100 100">
          <circle class="text-slate-800/50 stroke-current" stroke-width="3" cx="50" cy="50" r="46" fill="transparent"></circle>
          <circle id="progress-circle" class="text-cyan-400 stroke-current" stroke-width="3" stroke-linecap="round" cx="50" cy="50" r="46" fill="transparent" stroke-dasharray="0 289" style="filter: drop-shadow(0 0 6px rgba(34,211,238,0.8));"></circle>
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span id="progress-percent" class="text-2xl font-bold text-white">0%</span>
        </div>
      </div>
      <h3 id="progress-message" class="text-lg font-bold text-white mb-1 animate-pulse">å‡¦ç†ä¸­...</h3>
      <p id="progress-detail" class="text-sm text-slate-400"></p>
      <button id="cancel-button" class="mt-4 px-6 py-2 text-sm text-slate-500 hover:text-white rounded-full hover:bg-white/10 transition-all">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <!-- Editor -->
    <div id="editor-area" class="hidden space-y-4">
      
      <!-- Controls -->
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between bg-white/5 border border-white/10 rounded-xl p-3">
        <div class="flex gap-3 items-center justify-center md:justify-start">
          <span id="file-name" class="text-sm text-cyan-300 font-medium truncate max-w-[120px]"></span>
          <span id="slide-count" class="text-xs text-slate-500"></span>
        </div>
        <div class="flex gap-2 flex-wrap justify-center">
          <button id="download-clean-pptx-btn" class="flex-1 md:flex-none px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-lg text-xs font-medium transition-all flex items-center justify-center gap-1.5 shadow-lg touch-feedback" title="ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»æ¸ˆã¿PPTX">
            <i data-lucide="file-check" class="w-4 h-4"></i>
            <span>ã‚¯ãƒªãƒ¼ãƒ³PPTX</span>
          </button>
          <button id="download-zip-btn" class="px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg text-xs font-medium transition-all touch-feedback" title="æ¶ˆå»æ¸ˆã¿ç”»åƒZIP">
            <i data-lucide="file-archive" class="w-4 h-4"></i>
          </button>
          <button id="download-json-btn" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-medium transition-all touch-feedback" title="JSON">
            <i data-lucide="file-json" class="w-4 h-4"></i>
          </button>
          <button id="reset-btn" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-medium transition-all touch-feedback" title="ãƒªã‚»ãƒƒãƒˆ">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="flex flex-wrap gap-2 justify-center text-xs">
        <span class="px-3 py-1 bg-cyan-500/20 text-cyan-300 rounded-full"><span id="stat-blocks">0</span> ãƒ–ãƒ­ãƒƒã‚¯</span>
        <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full"><span id="stat-chars">0</span> æ–‡å­—</span>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 overflow-x-auto">
        <button id="tab-compare" class="tab-btn tab-active px-4 py-2 rounded-lg border border-white/10 text-sm font-medium flex items-center gap-2 whitespace-nowrap">
          <i data-lucide="columns" class="w-4 h-4"></i>æ¯”è¼ƒ
        </button>
        <button id="tab-blocks" class="tab-btn px-4 py-2 rounded-lg border border-white/10 text-sm font-medium flex items-center gap-2 whitespace-nowrap text-slate-400 hover:text-white">
          <i data-lucide="list" class="w-4 h-4"></i>ãƒ–ãƒ­ãƒƒã‚¯
        </button>
      </div>

      <!-- Compare Tab -->
      <div id="tab-content-compare" class="tab-content">
        <div class="bg-white/5 border border-white/10 rounded-xl p-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-white">å…ƒç”»åƒ vs ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»å¾Œ</h3>
            <div class="flex items-center gap-2">
              <button id="prev-compare" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-all">
                <i data-lucide="chevron-left" class="w-4 h-4"></i>
              </button>
              <span id="compare-index" class="text-xs text-slate-400">1/1</span>
              <button id="next-compare" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-lg transition-all">
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-slate-500 mb-2 text-center">å…ƒç”»åƒ</p>
              <div id="original-preview" class="bg-black/30 rounded-lg overflow-hidden"></div>
            </div>
            <div>
              <p class="text-xs text-slate-500 mb-2 text-center">ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»å¾Œ</p>
              <div id="erased-preview" class="bg-black/30 rounded-lg overflow-hidden"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Blocks Tab -->
      <div id="tab-content-blocks" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="bg-white/5 border border-white/10 rounded-xl p-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-sm font-bold text-white mb-3">ã‚¹ãƒ©ã‚¤ãƒ‰é¸æŠ</h3>
            <div id="block-slide-list" class="space-y-2"></div>
          </div>
          <div class="lg:col-span-2 bg-white/5 border border-white/10 rounded-xl p-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-sm font-bold text-white mb-3">ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ <span id="block-count" class="text-xs text-slate-400"></span></h3>
            <div id="block-list" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error -->
    <div id="error-area" class="hidden bg-white/5 rounded-2xl border border-white/10 p-12 text-center space-y-4">
      <div class="w-14 h-14 bg-red-500/20 rounded-full flex items-center justify-center mx-auto">
        <i data-lucide="x" class="w-7 h-7 text-red-500"></i>
      </div>
      <h3 class="text-lg font-bold text-slate-200">ã‚¨ãƒ©ãƒ¼</h3>
      <p id="error-message" class="text-slate-500 text-sm"></p>
      <button id="retry-btn" class="px-6 py-2 bg-white/10 text-white rounded-xl hover:bg-white/20 transition-all">ãƒªãƒˆãƒ©ã‚¤</button>
    </div>
  </main>

  <footer class="text-center text-xs text-slate-600 py-4">
    PDF Slide Studio Pro v4 â€¢ Text Erase & Replace
  </footer>
</div>
```

  </div>

  <!-- Toast -->

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden px-5 py-2.5 bg-slate-800 border border-slate-700 text-white rounded-xl shadow-xl">
    <div class="flex items-center gap-2">
      <i id="toast-icon" data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
      <span id="toast-message" class="text-sm">å®Œäº†</span>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    const state = {
      file: null,
      images: [],
      zipBlob: null,
      cancelRequested: false,
      isExporting: false,
      currentCompareIndex: 0,
      selectedSlideIndex: null,
      // Settings
      ocrLanguage: 'jpn+eng',
      eraseMargin: 5,
      minConfidence: 50,
      fontFamily: 'Meiryo',
      autoBold: true
    };

    const el = {
      fileInput: document.getElementById('file-input'),
      uploadArea: document.getElementById('upload-area'),
      uploadButton: document.getElementById('upload-button'),
      processingArea: document.getElementById('processing-area'),
      editorArea: document.getElementById('editor-area'),
      errorArea: document.getElementById('error-area'),
      initStatus: document.getElementById('init-status'),
      headerContent: document.getElementById('header-content'),
      progressCircle: document.getElementById('progress-circle'),
      progressPercent: document.getElementById('progress-percent'),
      progressMessage: document.getElementById('progress-message'),
      progressDetail: document.getElementById('progress-detail'),
      cancelButton: document.getElementById('cancel-button'),
      fileName: document.getElementById('file-name'),
      slideCount: document.getElementById('slide-count'),
      statBlocks: document.getElementById('stat-blocks'),
      statChars: document.getElementById('stat-chars'),
      downloadCleanPptxBtn: document.getElementById('download-clean-pptx-btn'),
      downloadZipBtn: document.getElementById('download-zip-btn'),
      downloadJsonBtn: document.getElementById('download-json-btn'),
      resetBtn: document.getElementById('reset-btn'),
      retryBtn: document.getElementById('retry-btn'),
      errorMessage: document.getElementById('error-message'),
      toast: document.getElementById('toast'),
      toastIcon: document.getElementById('toast-icon'),
      toastMessage: document.getElementById('toast-message'),
      // Settings
      ocrLanguage: document.getElementById('ocr-language'),
      eraseMargin: document.getElementById('erase-margin'),
      eraseMarginValue: document.getElementById('erase-margin-value'),
      minConfidence: document.getElementById('min-confidence'),
      minConfidenceValue: document.getElementById('min-confidence-value'),
      fontFamily: document.getElementById('font-family'),
      autoBold: document.getElementById('auto-bold'),
      // Tabs & Compare
      tabCompare: document.getElementById('tab-compare'),
      tabBlocks: document.getElementById('tab-blocks'),
      tabContentCompare: document.getElementById('tab-content-compare'),
      tabContentBlocks: document.getElementById('tab-content-blocks'),
      originalPreview: document.getElementById('original-preview'),
      erasedPreview: document.getElementById('erased-preview'),
      compareIndex: document.getElementById('compare-index'),
      prevCompare: document.getElementById('prev-compare'),
      nextCompare: document.getElementById('next-compare'),
      blockSlideList: document.getElementById('block-slide-list'),
      blockList: document.getElementById('block-list'),
      blockCount: document.getElementById('block-count')
    };

    lucide.createIcons();

    // Settings listeners
    el.eraseMargin.addEventListener('input', e => {
      state.eraseMargin = parseInt(e.target.value);
      el.eraseMarginValue.textContent = `${state.eraseMargin}px`;
    });
    el.minConfidence.addEventListener('input', e => {
      state.minConfidence = parseInt(e.target.value);
      el.minConfidenceValue.textContent = `${state.minConfidence}%`;
    });

    // Init
    (async () => {
      if (window.Tesseract) {
        el.initStatus.innerHTML = '<i data-lucide="check-circle" class="w-3 h-3 text-green-400"></i><span>æº–å‚™å®Œäº†</span>';
        lucide.createIcons();
        setTimeout(() => el.initStatus.classList.add('hidden'), 1500);
      }
    })();

    // ============================================
    // Text Erase Algorithm
    // ============================================
    function eraseTextFromCanvas(canvas, blocks, margin = 5) {
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // å…ƒã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      blocks.forEach(block => {
        if (!block.bbox) return;
        
        const x0 = Math.max(0, Math.floor(block.bbox.x0) - margin);
        const y0 = Math.max(0, Math.floor(block.bbox.y0) - margin);
        const x1 = Math.min(width, Math.ceil(block.bbox.x1) + margin);
        const y1 = Math.min(height, Math.ceil(block.bbox.y1) + margin);
        
        // å‘¨è¾ºã®èƒŒæ™¯è‰²ã‚’å–å¾—ï¼ˆé ˜åŸŸã®ä¸Šä¸‹å·¦å³ã®ç«¯ã‹ã‚‰ï¼‰
        const bgColor = estimateBackgroundColor(data, width, height, x0, y0, x1, y1);
        
        // é ˜åŸŸã‚’èƒŒæ™¯è‰²ã§å¡—ã‚Šã¤ã¶ã—
        for (let y = y0; y < y1; y++) {
          for (let x = x0; x < x1; x++) {
            const idx = (y * width + x) * 4;
            data[idx] = bgColor.r;
            data[idx + 1] = bgColor.g;
            data[idx + 2] = bgColor.b;
            // ã‚¢ãƒ«ãƒ•ã‚¡ã¯ç¶­æŒ
          }
        }
      });
      
      ctx.putImageData(imageData, 0, 0);
      return canvas;
    }

    function estimateBackgroundColor(data, width, height, x0, y0, x1, y1) {
      const samples = [];
      
      // ä¸Šç«¯
      if (y0 > 2) {
        for (let x = x0; x < x1; x += 5) {
          const idx = ((y0 - 2) * width + x) * 4;
          samples.push({ r: data[idx], g: data[idx + 1], b: data[idx + 2] });
        }
      }
      
      // ä¸‹ç«¯
      if (y1 < height - 2) {
        for (let x = x0; x < x1; x += 5) {
          const idx = ((y1 + 2) * width + x) * 4;
          samples.push({ r: data[idx], g: data[idx + 1], b: data[idx + 2] });
        }
      }
      
      // å·¦ç«¯
      if (x0 > 2) {
        for (let y = y0; y < y1; y += 5) {
          const idx = (y * width + (x0 - 2)) * 4;
          samples.push({ r: data[idx], g: data[idx + 1], b: data[idx + 2] });
        }
      }
      
      // å³ç«¯
      if (x1 < width - 2) {
        for (let y = y0; y < y1; y += 5) {
          const idx = (y * width + (x1 + 2)) * 4;
          samples.push({ r: data[idx], g: data[idx + 1], b: data[idx + 2] });
        }
      }
      
      if (samples.length === 0) {
        return { r: 255, g: 255, b: 255 };
      }
      
      // æœ€é »å‡ºè‰²ã‚’æ¢ã™ï¼ˆå˜ç´”ãªå¹³å‡ã ã¨ä¸­é–“è‰²ã«ãªã‚‹ãŸã‚ï¼‰
      const colorCounts = {};
      samples.forEach(s => {
        // è‰²ã‚’é‡å­åŒ–
        const qr = Math.round(s.r / 16) * 16;
        const qg = Math.round(s.g / 16) * 16;
        const qb = Math.round(s.b / 16) * 16;
        const key = `${qr},${qg},${qb}`;
        colorCounts[key] = (colorCounts[key] || 0) + 1;
      });
      
      let maxCount = 0;
      let dominantColor = '255,255,255';
      for (const [color, count] of Object.entries(colorCounts)) {
        if (count > maxCount) {
          maxCount = count;
          dominantColor = color;
        }
      }
      
      const [r, g, b] = dominantColor.split(',').map(Number);
      return { r, g, b };
    }

    // ============================================
    // Smart Text Merge
    // ============================================
    function smartMergeLines(lines, canvasWidth, canvasHeight) {
      if (!lines || lines.length === 0) return [];
      
      // ãƒ•ã‚£ãƒ«ã‚¿
      let filtered = lines.filter(line => {
        if (!line.text || !line.bbox) return false;
        if (line.confidence < state.minConfidence) return false;
        const text = line.text.trim();
        if (text.length < 2) return false;
        if (/^[\s\-_=|\\\/\[\]{}()"'`~!@#$%^&*]+$/.test(text)) return false;
        return true;
      });
      
      if (filtered.length === 0) return [];
      
      // Yåº§æ¨™ã§ã‚½ãƒ¼ãƒˆ
      filtered.sort((a, b) => a.bbox.y0 - b.bbox.y0);
      
      // è¡Œã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const lineGroups = [];
      let currentGroup = null;
      
      filtered.forEach(line => {
        if (!currentGroup) {
          currentGroup = {
            lines: [line],
            y0: line.bbox.y0, y1: line.bbox.y1,
            x0: line.bbox.x0, x1: line.bbox.x1
          };
        } else {
          const overlapY = Math.min(currentGroup.y1, line.bbox.y1) - Math.max(currentGroup.y0, line.bbox.y0);
          const lineHeight = Math.min(currentGroup.y1 - currentGroup.y0, line.bbox.y1 - line.bbox.y0);
          
          if (overlapY > lineHeight * 0.4) {
            currentGroup.lines.push(line);
            currentGroup.x0 = Math.min(currentGroup.x0, line.bbox.x0);
            currentGroup.x1 = Math.max(currentGroup.x1, line.bbox.x1);
            currentGroup.y0 = Math.min(currentGroup.y0, line.bbox.y0);
            currentGroup.y1 = Math.max(currentGroup.y1, line.bbox.y1);
          } else {
            lineGroups.push(currentGroup);
            currentGroup = {
              lines: [line],
              y0: line.bbox.y0, y1: line.bbox.y1,
              x0: line.bbox.x0, x1: line.bbox.x1
            };
          }
        }
      });
      if (currentGroup) lineGroups.push(currentGroup);
      
      // Xé †ã«ã‚½ãƒ¼ãƒˆã—ã¦ãƒ†ã‚­ã‚¹ãƒˆçµåˆ
      lineGroups.forEach(group => {
        group.lines.sort((a, b) => a.bbox.x0 - b.bbox.x0);
        group.text = group.lines.map(l => l.text.trim()).join(' ');
        group.confidence = Math.round(group.lines.reduce((sum, l) => sum + l.confidence, 0) / group.lines.length);
      });
      
      // æ®µè½ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const paragraphs = [];
      let currentPara = null;
      const mergeThreshold = 35;
      
      lineGroups.forEach(group => {
        if (!currentPara) {
          currentPara = {
            lines: [group],
            text: group.text,
            bbox: { x0: group.x0, y0: group.y0, x1: group.x1, y1: group.y1 },
            confidence: group.confidence
          };
        } else {
          const gap = group.y0 - currentPara.bbox.y1;
          const xOverlap = Math.min(currentPara.bbox.x1, group.x1) - Math.max(currentPara.bbox.x0, group.x0);
          const minWidth = Math.min(currentPara.bbox.x1 - currentPara.bbox.x0, group.x1 - group.x0);
          const xOverlapRatio = xOverlap / minWidth;
          
          if (gap < mergeThreshold && gap > -10 && xOverlapRatio > 0.2) {
            currentPara.lines.push(group);
            currentPara.text += '\n' + group.text;
            currentPara.bbox.x0 = Math.min(currentPara.bbox.x0, group.x0);
            currentPara.bbox.x1 = Math.max(currentPara.bbox.x1, group.x1);
            currentPara.bbox.y1 = group.y1;
            currentPara.confidence = Math.round((currentPara.confidence + group.confidence) / 2);
          } else {
            paragraphs.push(currentPara);
            currentPara = {
              lines: [group],
              text: group.text,
              bbox: { x0: group.x0, y0: group.y0, x1: group.x1, y1: group.y1 },
              confidence: group.confidence
            };
          }
        }
      });
      if (currentPara) paragraphs.push(currentPara);
      
      return paragraphs.map((para, idx) => ({
        id: idx,
        text: para.text,
        confidence: para.confidence,
        bbox: para.bbox,
        lineCount: para.lines.length,
        fontSize: estimateFontSize(para.bbox, para.lines.length)
      }));
    }

    function estimateFontSize(bbox, lineCount) {
      const height = bbox.y1 - bbox.y0;
      const lineHeight = height / lineCount;
      // ãŠãŠã‚ˆãã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼ˆãƒ”ã‚¯ã‚»ãƒ« -> ptå¤‰æ›ï¼‰
      return Math.max(8, Math.min(48, Math.round(lineHeight * 0.7)));
    }

    // ============================================
    // OCR
    // ============================================
    async function performOCR(imageDataUrl, language) {
      if (!window.Tesseract) return { text: '', confidence: 0, lines: [] };
      
      try {
        const worker = await Tesseract.createWorker(language, 1, {
          logger: m => {
            if (m.status === 'recognizing text') {
              el.progressDetail.textContent = `OCR: ${Math.round(m.progress * 100)}%`;
            }
          }
        });
        
        const result = await worker.recognize(imageDataUrl);
        await worker.terminate();
        
        return {
          text: result.data.text.trim(),
          confidence: Math.round(result.data.confidence),
          lines: result.data.lines || []
        };
      } catch (err) {
        console.error('OCR Error:', err);
        return { text: '', confidence: 0, lines: [] };
      }
    }

    // ============================================
    // Event Listeners
    // ============================================
    el.uploadButton.addEventListener('click', e => { e.preventDefault(); el.fileInput.click(); });
    
    el.fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        state.ocrLanguage = el.ocrLanguage.value;
        state.fontFamily = el.fontFamily.value;
        state.autoBold = el.autoBold.checked;
        processFile(file);
      }
    });

    el.uploadButton.addEventListener('dragover', e => { e.preventDefault(); el.uploadButton.classList.add('bg-indigo-500/10'); });
    el.uploadButton.addEventListener('dragleave', e => { e.preventDefault(); el.uploadButton.classList.remove('bg-indigo-500/10'); });
    el.uploadButton.addEventListener('drop', e => {
      e.preventDefault();
      el.uploadButton.classList.remove('bg-indigo-500/10');
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        state.ocrLanguage = el.ocrLanguage.value;
        state.fontFamily = el.fontFamily.value;
        state.autoBold = el.autoBold.checked;
        processFile(file);
      }
    });

    el.cancelButton.addEventListener('click', () => { state.cancelRequested = true; });
    el.resetBtn.addEventListener('click', reset);
    el.retryBtn.addEventListener('click', reset);

    el.downloadCleanPptxBtn.addEventListener('click', downloadCleanPptx);
    el.downloadZipBtn.addEventListener('click', downloadZip);
    el.downloadJsonBtn.addEventListener('click', downloadJson);

    el.prevCompare.addEventListener('click', () => navigateCompare(-1));
    el.nextCompare.addEventListener('click', () => navigateCompare(1));

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.id.replace('tab-', '')));
    });

    // ============================================
    // Process PDF
    // ============================================
    async function processFile(file) {
      state.file = file;
      state.images = [];
      state.zipBlob = null;
      state.cancelRequested = false;
      state.currentCompareIndex = 0;
      
      showProcessing();
      updateProgress(0, 0, 'PDFè§£æä¸­...', '');

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const totalPages = pdf.numPages;

        const zip = new JSZip();

        for (let i = 1; i <= totalPages; i++) {
          if (state.cancelRequested) { reset(); showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'info'); return; }

          updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...');

          const page = await pdf.getPage(i);
          const scale = 2.0;
          const viewport = page.getViewport({ scale });

          // å…ƒç”»åƒç”¨Canvas
          const originalCanvas = document.createElement('canvas');
          originalCanvas.width = viewport.width;
          originalCanvas.height = viewport.height;
          const originalCtx = originalCanvas.getContext('2d');
          await page.render({ canvasContext: originalCtx, viewport }).promise;
          const originalDataUrl = originalCanvas.toDataURL('image/png');

          // OCR
          updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'OCRå‡¦ç†ä¸­...');
          const ocrResult = await performOCR(originalDataUrl, state.ocrLanguage);

          // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ã‚¸
          updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ã‚¸ä¸­...');
          const blocks = smartMergeLines(ocrResult.lines, viewport.width, viewport.height);

          // ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»ç”¨Canvasï¼ˆã‚³ãƒ”ãƒ¼ï¼‰
          updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»ä¸­...');
          const erasedCanvas = document.createElement('canvas');
          erasedCanvas.width = viewport.width;
          erasedCanvas.height = viewport.height;
          const erasedCtx = erasedCanvas.getContext('2d');
          erasedCtx.drawImage(originalCanvas, 0, 0);
          
          // ãƒ†ã‚­ã‚¹ãƒˆé ˜åŸŸã‚’æ¶ˆå»
          eraseTextFromCanvas(erasedCanvas, blocks, state.eraseMargin);
          const erasedDataUrl = erasedCanvas.toDataURL('image/png');
          const erasedBlob = await new Promise(resolve => erasedCanvas.toBlob(resolve, 'image/png'));

          state.images.push({
            id: i,
            originalDataUrl,
            erasedDataUrl,
            erasedBlob,
            width: viewport.width,
            height: viewport.height,
            blocks,
            text: ocrResult.text
          });

          zip.file(`slide_${String(i).padStart(2, '0')}_clean.png`, erasedBlob);

          // ãƒ¡ãƒ¢ãƒªè§£æ”¾
          originalCanvas.width = 0;
          erasedCanvas.width = 0;
          await new Promise(r => setTimeout(r, 20));
        }

        if (state.cancelRequested) { reset(); showToast('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'info'); return; }

        updateProgress(totalPages, totalPages, 'ZIPä½œæˆä¸­...', '');
        state.zipBlob = await zip.generateAsync({ type: 'blob' });

        showEditor();
        showToast(`${totalPages}æšã®å‡¦ç†å®Œäº†`, 'success');
      } catch (err) {
        console.error('Error:', err);
        showError('PDFã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // ============================================
    // UI Functions
    // ============================================
    function showProcessing() {
      el.uploadArea.classList.add('hidden');
      el.processingArea.classList.remove('hidden');
      el.processingArea.style.display = 'flex';
      el.editorArea.classList.add('hidden');
      el.errorArea.classList.add('hidden');
      el.headerContent.classList.add('hidden');
    }

    function showEditor() {
      el.uploadArea.classList.add('hidden');
      el.processingArea.classList.add('hidden');
      el.processingArea.style.display = 'none';
      el.editorArea.classList.remove('hidden');
      el.errorArea.classList.add('hidden');
      el.headerContent.classList.add('hidden');

      el.fileName.textContent = state.file.name;
      el.slideCount.textContent = `${state.images.length} ã‚¹ãƒ©ã‚¤ãƒ‰`;

      const totalBlocks = state.images.reduce((sum, img) => sum + (img.blocks?.length || 0), 0);
      const totalChars = state.images.reduce((sum, img) => sum + (img.text?.length || 0), 0);
      el.statBlocks.textContent = totalBlocks;
      el.statChars.textContent = totalChars.toLocaleString();

      updateCompareView();
      renderBlockSlideList();
    }

    function showError(message) {
      el.uploadArea.classList.add('hidden');
      el.processingArea.classList.add('hidden');
      el.editorArea.classList.add('hidden');
      el.errorArea.classList.remove('hidden');
      el.headerContent.classList.remove('hidden');
      el.errorMessage.textContent = message;
    }

    function reset() {
      state.file = null;
      state.images = [];
      state.zipBlob = null;
      state.cancelRequested = false;
      state.currentCompareIndex = 0;
      el.fileInput.value = '';

      el.uploadArea.classList.remove('hidden');
      el.processingArea.classList.add('hidden');
      el.editorArea.classList.add('hidden');
      el.errorArea.classList.add('hidden');
      el.headerContent.classList.remove('hidden');
      
      switchTab('compare');
    }

    function updateProgress(current, total, message, detail) {
      const percent = total > 0 ? Math.round((current / total) * 100) : 0;
      el.progressCircle.setAttribute('stroke-dasharray', `${289 * percent / 100} 289`);
      el.progressPercent.textContent = `${percent}%`;
      el.progressMessage.textContent = message;
      el.progressDetail.textContent = detail;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.add('text-slate-400');
      });
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));

      const tab = document.getElementById(`tab-${tabName}`);
      const content = document.getElementById(`tab-content-${tabName}`);
      if (tab && content) {
        tab.classList.add('tab-active');
        tab.classList.remove('text-slate-400');
        content.classList.remove('hidden');
      }
    }

    function updateCompareView() {
      if (state.images.length === 0) return;
      
      const img = state.images[state.currentCompareIndex];
      el.compareIndex.textContent = `${state.currentCompareIndex + 1}/${state.images.length}`;
      
      el.originalPreview.innerHTML = `<img src="${img.originalDataUrl}" class="w-full h-auto">`;
      el.erasedPreview.innerHTML = `<img src="${img.erasedDataUrl}" class="w-full h-auto">`;
    }

    function navigateCompare(dir) {
      const newIdx = state.currentCompareIndex + dir;
      if (newIdx >= 0 && newIdx < state.images.length) {
        state.currentCompareIndex = newIdx;
        updateCompareView();
      }
    }

    function renderBlockSlideList() {
      el.blockSlideList.innerHTML = '';
      state.images.forEach((img, idx) => {
        const btn = document.createElement('button');
        btn.className = `w-full p-2.5 rounded-lg text-left text-sm transition-all ${state.selectedSlideIndex === idx ? 'bg-cyan-600 text-white' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'}`;
        btn.innerHTML = `<div class="flex justify-between"><span>ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}</span><span class="text-xs opacity-70">${img.blocks?.length || 0}B</span></div>`;
        btn.addEventListener('click', () => selectSlide(idx));
        el.blockSlideList.appendChild(btn);
      });
    }

    function selectSlide(idx) {
      state.selectedSlideIndex = idx;
      const img = state.images[idx];
      
      el.blockCount.textContent = `(${img.blocks?.length || 0})`;
      
      if (img.blocks && img.blocks.length > 0) {
        el.blockList.innerHTML = img.blocks.map((b, i) => `
          <div class="p-3 bg-slate-800/50 rounded-lg border-l-2 border-cyan-500">
            <div class="flex justify-between mb-1">
              <span class="text-xs font-bold text-cyan-300">B${i + 1}</span>
              <span class="text-xs text-slate-500">${b.confidence}% / ${b.fontSize}pt</span>
            </div>
            <p class="text-sm text-slate-200 whitespace-pre-wrap">${b.text}</p>
          </div>
        `).join('');
      } else {
        el.blockList.innerHTML = '<p class="text-slate-500 text-sm">ãƒ–ãƒ­ãƒƒã‚¯ãªã—</p>';
      }
      
      renderBlockSlideList();
    }

    function showToast(message, type = 'success') {
      el.toastMessage.textContent = message;
      const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info';
      const iconColor = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';
      el.toastIcon.setAttribute('data-lucide', iconName);
      el.toastIcon.className = `w-4 h-4 ${iconColor}`;
      lucide.createIcons();
      el.toast.classList.remove('hidden');
      setTimeout(() => el.toast.classList.add('hidden'), 2500);
    }

    // ============================================
    // Download Functions
    // ============================================
    function downloadFile(blob, filename) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function setButtonsDisabled(disabled) {
      state.isExporting = disabled;
      el.downloadCleanPptxBtn.disabled = disabled;
      el.downloadZipBtn.disabled = disabled;
      el.downloadJsonBtn.disabled = disabled;
    }

    async function downloadCleanPptx() {
      if (!state.images.length || state.isExporting) return;

      try {
        setButtonsDisabled(true);
        showToast('PPTXä½œæˆä¸­...', 'info');

        const pptx = new PptxGenJS();
        const slideWidth = 10;
        const slideHeight = 5.625;
        pptx.defineLayout({ name: 'CUSTOM', width: slideWidth, height: slideHeight });
        pptx.layout = 'CUSTOM';

        for (const img of state.images) {
          const slide = pptx.addSlide();
          
          // ãƒ†ã‚­ã‚¹ãƒˆæ¶ˆå»æ¸ˆã¿èƒŒæ™¯
          slide.addImage({
            data: img.erasedDataUrl,
            x: 0, y: 0,
            w: slideWidth, h: slideHeight
          });
          
          // ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’é…ç½®
          if (img.blocks && img.blocks.length > 0) {
            img.blocks.forEach(block => {
              if (!block.bbox || !block.text) return;
              
              const x = (block.bbox.x0 / img.width) * slideWidth;
              const y = (block.bbox.y0 / img.height) * slideHeight;
              const w = ((block.bbox.x1 - block.bbox.x0) / img.width) * slideWidth;
              const h = ((block.bbox.y1 - block.bbox.y0) / img.height) * slideHeight;
              
              // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’PPTXç”¨ã«èª¿æ•´ï¼ˆpx -> ptï¼‰
              const fontSize = Math.max(8, Math.min(36, Math.round(block.fontSize * 0.6)));
              const isBold = state.autoBold && fontSize > 14;
              
              slide.addText(block.text, {
                x: Math.max(0, x - 0.02),
                y: Math.max(0, y - 0.01),
                w: Math.max(w + 0.04, 0.5),
                h: Math.max(h + 0.02, 0.2),
                fontSize: fontSize,
                fontFace: state.fontFamily,
                color: '333333',
                bold: isBold,
                valign: 'top',
                wrap: true
              });
            });
          }
          
          // ãƒãƒ¼ãƒˆã«å…¨ãƒ†ã‚­ã‚¹ãƒˆ
          if (img.text) {
            slide.addNotes(img.text);
          }
        }

        const filename = state.file.name.replace('.pdf', '') + '_clean.pptx';
        await pptx.writeFile({ fileName: filename });
        
        showToast('ã‚¯ãƒªãƒ¼ãƒ³PPTXå®Œæˆï¼', 'success');
      } catch (err) {
        console.error('PPTX error:', err);
        showToast('PPTXä½œæˆå¤±æ•—', 'error');
      } finally {
        setButtonsDisabled(false);
      }
    }

    function downloadZip() {
      if (state.zipBlob && state.file) {
        downloadFile(state.zipBlob, state.file.name.replace('.pdf', '') + '_clean_images.zip');
        showToast('ZIPãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
      }
    }

    function downloadJson() {
      if (!state.images.length) return;

      const data = {
        filename: state.file.name,
        processedAt: new Date().toISOString(),
        settings: {
          eraseMargin: state.eraseMargin,
          minConfidence: state.minConfidence,
          fontFamily: state.fontFamily
        },
        slides: state.images.map((img, idx) => ({
          slideNumber: idx + 1,
          width: img.width,
          height: img.height,
          blocks: img.blocks || []
        }))
      };

      downloadFile(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }), state.file.name.replace('.pdf', '') + '_data.json');
      showToast('JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
    }
  </script>

</body>
</html>
