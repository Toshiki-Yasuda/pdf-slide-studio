<!DOCTYPE html>

<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>PDF Slide Studio Pro - OCRï¼†å›³å½¢åˆ†è§£å¯¾å¿œ</title>
  <meta name="description" content="PDFã‚¹ãƒ©ã‚¤ãƒ‰ã‚’OCRã§ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã€å›³å½¢ã‚’è‡ªå‹•åˆ†è§£ã€‚PNGã€PowerPointã€GIFã€é•·ç”»åƒã«å¤‰æ›ã€‚">

  <!-- OGP / SNSå…±æœ‰ -->

  <meta property="og:title" content="PDF Slide Studio Pro">
  <meta property="og:description" content="PDFã‚¹ãƒ©ã‚¤ãƒ‰ã‚’OCRã§ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã€å›³å½¢åˆ†è§£ã€‚å®Œå…¨ã«ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://toshiki-yasuda.github.io/pdf-slide-studio/">
  <meta name="twitter:card" content="summary">

  <!-- Favicon -->

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“„</text></svg>">

  <!-- Tailwind CSS -->

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- External Libraries -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <!-- Tesseract.js for OCR -->

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <!-- Lucide Icons -->

  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <style>
    * {
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    
    @keyframes aurora-1 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(20px, -20px) scale(1.1); }
    }
    @keyframes aurora-2 {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(-20px, 10px) scale(1.2); }
    }
    .animate-aurora-1 { animation: aurora-1 10s infinite ease-in-out; }
    .animate-aurora-2 { animation: aurora-2 12s infinite ease-in-out; }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin { animation: spin 1s linear infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¿ãƒƒãƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    @media (hover: none) and (pointer: coarse) {
      .touch-feedback:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚° */
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring__circle {
      transition: stroke-dasharray 0.3s ease;
    }
    
    /* ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–çŠ¶æ…‹ */
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-active {
      background: rgba(6, 182, 212, 0.2);
      border-color: rgb(6, 182, 212);
      color: rgb(6, 182, 212);
    }
    
    /* å›³å½¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .shape-overlay {
      position: absolute;
      border: 2px solid;
      pointer-events: none;
      opacity: 0.7;
    }
    
    /* ç·¨é›†å¯èƒ½ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    .editable-text {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s;
    }
    .editable-text:focus {
      background: rgba(0,0,0,0.5);
      border-color: rgba(6, 182, 212, 0.5);
      outline: none;
    }
  </style>

</head>
<body class="bg-slate-950 text-slate-200 min-h-screen">

  <!-- Aurora Background -->

  <div class="fixed inset-0 pointer-events-none overflow-hidden" aria-hidden="true">
    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-indigo-600/20 rounded-full blur-[100px] animate-aurora-1"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-cyan-600/20 rounded-full blur-[100px] animate-aurora-2"></div>
  </div>

  <!-- Main App Container -->

  <div id="app" class="relative z-10 min-h-screen p-4 md:p-6">
    <div class="w-full max-w-7xl mx-auto space-y-6 md:space-y-8">

```
  <!-- Header -->
  <header class="text-center space-y-4 md:space-y-6 pt-2 md:pt-4">
    <div class="inline-flex items-center gap-2 px-3 md:px-4 py-1.5 rounded-full bg-white/5 border border-white/10 backdrop-blur-md">
      <i data-lucide="sparkles" class="w-3.5 h-3.5 text-cyan-300" aria-hidden="true"></i>
      <span class="text-[10px] md:text-[11px] uppercase tracking-[0.15em] md:tracking-[0.2em] font-bold text-cyan-300/90">PDF Slide Studio Pro</span>
    </div>
    
    <div id="header-content">
      <h1 class="text-2xl md:text-4xl lg:text-5xl font-extrabold tracking-tight text-white leading-tight px-2">
        OCRï¼†å›³å½¢åˆ†è§£å¯¾å¿œ
      </h1>
      <p class="text-slate-400 text-sm md:text-lg max-w-2xl mx-auto font-light px-4 mt-4">
        ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºãƒ»å›³å½¢æ¤œå‡ºãƒ»è¤‡æ•°å½¢å¼å¤‰æ›ã€‚å®Œå…¨ã«ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‡¦ç†ã€‚
      </p>
    </div>
  </header>

  <!-- Main Content Area -->
  <main id="main-content" role="main">
    
    <!-- Upload Area (Default State) -->
    <div id="upload-area" class="bg-white/5 backdrop-blur-2xl rounded-2xl md:rounded-[2.5rem] shadow-[0_8px_32px_0_rgba(0,0,0,0.36)] border border-white/10 overflow-hidden">
      <input 
        type="file" 
        id="file-input" 
        class="hidden" 
        accept="application/pdf,.pdf"
        aria-label="PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ"
      >
      
      <button 
        type="button" 
        id="upload-button"
        class="relative w-full p-12 md:p-20 text-center cursor-pointer group transition-all duration-300 hover:bg-white/5 active:bg-white/10 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 touch-feedback"
        aria-describedby="upload-description"
      >
        <div class="flex flex-col items-center gap-6 md:gap-8">
          <div id="upload-icon" class="w-20 h-20 md:w-24 md:h-24 rounded-2xl md:rounded-3xl flex items-center justify-center bg-slate-800/50 text-cyan-300 group-hover:bg-slate-800/80 transition-all duration-300">
            <i data-lucide="file-text" class="w-8 h-8 md:w-10 md:h-10" aria-hidden="true"></i>
          </div>
          <div class="space-y-2 md:space-y-3">
            <p class="text-xl md:text-2xl font-bold text-slate-200 group-hover:text-white transition-colors">
              PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
            </p>
            <p id="upload-description" class="text-xs md:text-sm text-slate-500">
              ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ ã¾ãŸã¯ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            </p>
          </div>
          
          <!-- OCRè¨­å®š -->
          <div class="flex flex-wrap gap-3 justify-center mt-2">
            <label class="flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800/80 transition-all">
              <input type="checkbox" id="ocr-enabled" checked class="w-4 h-4 rounded text-cyan-500">
              <span class="text-sm text-slate-300">OCRãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º</span>
            </label>
            <label class="flex items-center gap-2 px-4 py-2 bg-slate-800/50 rounded-lg cursor-pointer hover:bg-slate-800/80 transition-all">
              <input type="checkbox" id="shape-detection-enabled" checked class="w-4 h-4 rounded text-cyan-500">
              <span class="text-sm text-slate-300">å›³å½¢æ¤œå‡º</span>
            </label>
          </div>
          
          <!-- è¨€èªé¸æŠ -->
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">OCRè¨€èª:</span>
            <select id="ocr-language" class="bg-slate-800/50 border border-slate-700 rounded-lg px-3 py-1.5 text-sm text-slate-300 focus:outline-none focus:border-cyan-500">
              <option value="jpn+eng">æ—¥æœ¬èª+è‹±èª</option>
              <option value="jpn">æ—¥æœ¬èªã®ã¿</option>
              <option value="eng">è‹±èªã®ã¿</option>
              <option value="chi_sim+eng">ä¸­å›½èª(ç°¡ä½“)+è‹±èª</option>
              <option value="kor+eng">éŸ“å›½èª+è‹±èª</option>
            </select>
          </div>
          
          <!-- æ˜ç¤ºçš„ãªé¸æŠãƒœã‚¿ãƒ³ -->
          <div class="mt-2 px-6 py-3 bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 text-white rounded-xl font-medium text-sm md:text-base transition-all shadow-lg shadow-cyan-600/30 flex items-center gap-2">
            <i data-lucide="folder-open" class="w-5 h-5" aria-hidden="true"></i>
            ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
          </div>
          
          <div id="init-status" class="inline-flex items-center gap-2 px-4 py-2 bg-black/20 border border-white/5 text-slate-400 text-xs font-medium rounded-full mt-4 backdrop-blur-sm">
            <i data-lucide="loader-2" class="w-3 h-3 animate-spin text-cyan-400" aria-hidden="true"></i>
            <span>OCRã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­...</span>
          </div>
        </div>
      </button>
    </div>

    <!-- Processing View (Hidden by default) -->
    <div id="processing-area" class="hidden bg-white/5 backdrop-blur-2xl rounded-2xl md:rounded-[2.5rem] border border-white/10 overflow-hidden p-12 md:p-20 flex-col items-center justify-center min-h-[400px] md:min-h-[500px]" role="status" aria-live="polite">
      <div class="relative w-36 h-36 md:w-48 md:h-48 mb-8 md:mb-10">
        <svg class="w-full h-full progress-ring" viewBox="0 0 100 100" aria-hidden="true">
          <circle class="text-slate-800/50 stroke-current" stroke-width="2" cx="50" cy="50" r="46" fill="transparent"></circle>
          <circle 
            id="progress-circle"
            class="text-cyan-400 stroke-current progress-ring__circle" 
            stroke-width="2" 
            stroke-linecap="round" 
            cx="50" cy="50" r="46" 
            fill="transparent"
            stroke-dasharray="0 289.02"
            style="filter: drop-shadow(0 0 8px rgba(34,211,238,0.8));"
          ></circle>
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span id="progress-percent" class="text-3xl md:text-4xl font-bold text-white">0%</span>
        </div>
      </div>
      <h3 id="progress-message" class="text-lg md:text-xl font-bold text-white mb-2 animate-pulse text-center px-4">
        æº–å‚™ä¸­...
      </h3>
      <p id="progress-detail" class="text-sm text-slate-400 text-center"></p>
      <button id="cancel-button" class="mt-6 px-8 py-3 text-sm font-bold text-slate-500 hover:text-white active:text-white rounded-full hover:bg-white/10 active:bg-white/20 transition-all touch-feedback">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>

    <!-- Editor View (Hidden by default) -->
    <div id="editor-area" class="hidden space-y-4 md:space-y-6">
      
      <!-- Controls -->
      <div class="flex flex-col md:flex-row gap-3 md:gap-4 items-stretch md:items-center justify-between bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl md:rounded-2xl p-3 md:p-4">
        <div class="flex gap-4 items-center justify-center md:justify-start">
          <span id="file-name" class="text-sm text-cyan-300 font-medium truncate max-w-[150px]"></span>
          <span id="slide-count" class="text-xs text-slate-500"></span>
        </div>
        <div class="flex gap-2 flex-wrap justify-center md:justify-end">
          <button id="download-zip-btn" class="flex-1 md:flex-none px-3 md:px-4 py-2.5 bg-cyan-600 hover:bg-cyan-700 active:bg-cyan-800 disabled:bg-cyan-600 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="PNGç”»åƒã‚’ZIPå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
            <i data-lucide="file-archive" class="w-4 h-4" aria-hidden="true"></i>
            <span class="hidden sm:inline">ZIP</span>
          </button>
          <button id="download-pptx-btn" class="flex-1 md:flex-none px-3 md:px-4 py-2.5 bg-orange-600 hover:bg-orange-700 active:bg-orange-800 disabled:bg-orange-600 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="PowerPointå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
            <i data-lucide="presentation" class="w-4 h-4" aria-hidden="true"></i>
            <span class="hidden sm:inline">PPTX</span>
          </button>
          <button id="download-gif-btn" class="flex-1 md:flex-none px-3 md:px-4 py-2.5 bg-purple-600 hover:bg-purple-700 active:bg-purple-800 disabled:bg-purple-600 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³GIF">
            <i data-lucide="film" class="w-4 h-4" aria-hidden="true"></i>
            <span class="hidden sm:inline">GIF</span>
          </button>
          <button id="download-json-btn" class="flex-1 md:flex-none px-3 md:px-4 py-2.5 bg-green-600 hover:bg-green-700 active:bg-green-800 disabled:bg-green-600 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="OCRãƒ†ã‚­ã‚¹ãƒˆï¼†å›³å½¢ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
            <i data-lucide="file-json" class="w-4 h-4" aria-hidden="true"></i>
            <span class="hidden sm:inline">JSON</span>
          </button>
          <button id="download-text-btn" class="flex-1 md:flex-none px-3 md:px-4 py-2.5 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 disabled:bg-blue-600 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="å…¨ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
            <i data-lucide="file-text" class="w-4 h-4" aria-hidden="true"></i>
            <span class="hidden sm:inline">TXT</span>
          </button>
          <button id="reset-btn" class="px-3 md:px-4 py-2.5 bg-slate-700 hover:bg-slate-600 active:bg-slate-500 text-white rounded-lg text-xs md:text-sm font-medium transition-all flex items-center justify-center gap-1.5 touch-feedback" title="ãƒªã‚»ãƒƒãƒˆ">
            <i data-lucide="refresh-cw" class="w-4 h-4" aria-hidden="true"></i>
          </button>
        </div>
      </div>

      <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
      <div class="flex gap-2 overflow-x-auto pb-2">
        <button id="tab-preview" class="tab-btn tab-active px-4 py-2 rounded-lg border border-white/10 text-sm font-medium transition-all flex items-center gap-2 whitespace-nowrap">
          <i data-lucide="layout-grid" class="w-4 h-4"></i>
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        </button>
        <button id="tab-text" class="tab-btn px-4 py-2 rounded-lg border border-white/10 text-sm font-medium transition-all flex items-center gap-2 whitespace-nowrap text-slate-400 hover:text-white hover:bg-white/5">
          <i data-lucide="file-text" class="w-4 h-4"></i>
          ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†
        </button>
        <button id="tab-shapes" class="tab-btn px-4 py-2 rounded-lg border border-white/10 text-sm font-medium transition-all flex items-center gap-2 whitespace-nowrap text-slate-400 hover:text-white hover:bg-white/5">
          <i data-lucide="shapes" class="w-4 h-4"></i>
          å›³å½¢ä¸€è¦§
        </button>
      </div>

      <!-- Preview Tab Content -->
      <div id="tab-content-preview" class="tab-content">
        <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl md:rounded-2xl p-3 md:p-4">
          <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
            <i data-lucide="layout-grid" class="w-4 h-4" aria-hidden="true"></i>
            ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            <span id="ocr-status" class="text-xs text-cyan-400 ml-2"></span>
          </h3>
          <div id="slide-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4 max-h-[60vh] overflow-y-auto custom-scrollbar" role="list">
            <!-- Slides will be inserted here -->
          </div>
        </div>
      </div>

      <!-- Text Edit Tab Content -->
      <div id="tab-content-text" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Slide Selector -->
          <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
              <i data-lucide="list" class="w-4 h-4"></i>
              ã‚¹ãƒ©ã‚¤ãƒ‰é¸æŠ
            </h3>
            <div id="slide-list" class="space-y-2">
              <!-- Slide buttons will be inserted here -->
            </div>
          </div>
          
          <!-- Text Editor -->
          <div class="lg:col-span-2 bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold text-white flex items-center gap-2">
                <i data-lucide="edit-3" class="w-4 h-4"></i>
                <span id="text-editor-title">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
              </h3>
              <div id="text-confidence" class="text-xs text-slate-400"></div>
            </div>
            <div id="slide-preview-container" class="mb-4 bg-black/30 rounded-lg overflow-hidden max-h-[200px] flex items-center justify-center">
              <p class="text-slate-500 text-sm p-8">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
            <textarea 
              id="text-editor" 
              class="w-full h-48 md:h-64 bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-slate-200 text-sm font-mono resize-none editable-text"
              placeholder="ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨OCRã§æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."
              disabled
            ></textarea>
            <div class="flex items-center justify-between mt-3">
              <span id="text-char-count" class="text-xs text-slate-500">0 æ–‡å­—</span>
              <button id="copy-text-btn" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-xs font-medium transition-all flex items-center gap-2" disabled>
                <i data-lucide="copy" class="w-3 h-3"></i>
                ã‚³ãƒ”ãƒ¼
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Shapes Tab Content -->
      <div id="tab-content-shapes" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Slide Selector for Shapes -->
          <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4 max-h-[70vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
              <i data-lucide="list" class="w-4 h-4"></i>
              ã‚¹ãƒ©ã‚¤ãƒ‰é¸æŠ
            </h3>
            <div id="shape-slide-list" class="space-y-2">
              <!-- Slide buttons will be inserted here -->
            </div>
          </div>
          
          <!-- Shape List & Preview -->
          <div class="lg:col-span-2 space-y-4">
            <!-- Shape Preview with Overlay -->
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                <i data-lucide="scan" class="w-4 h-4"></i>
                <span id="shape-preview-title">å›³å½¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
              </h3>
              <div id="shape-preview-container" class="relative bg-black/30 rounded-lg overflow-hidden">
                <p class="text-slate-500 text-sm p-8 text-center">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é¸æŠã™ã‚‹ã¨æ¤œå‡ºã•ã‚ŒãŸå›³å½¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
              </div>
            </div>
            
            <!-- Shape List -->
            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-xl p-4 max-h-[300px] overflow-y-auto custom-scrollbar">
              <h3 class="text-sm font-bold text-white mb-3 flex items-center gap-2">
                <i data-lucide="shapes" class="w-4 h-4"></i>
                æ¤œå‡ºã•ã‚ŒãŸå›³å½¢
                <span id="shape-count" class="text-xs text-slate-400 ml-2">(0)</span>
              </h3>
              <div id="shape-list" class="space-y-2">
                <p class="text-slate-500 text-sm">å›³å½¢ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Error View (Hidden by default) -->
    <div id="error-area" class="hidden bg-white/5 backdrop-blur-2xl rounded-2xl md:rounded-[2.5rem] border border-white/10 p-12 md:p-20 text-center space-y-6" role="alert">
      <div class="w-16 h-16 md:w-20 md:h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto">
        <i data-lucide="x" class="w-8 h-8 md:w-10 md:h-10 text-red-500" aria-hidden="true"></i>
      </div>
      <h3 class="text-lg md:text-xl font-bold text-slate-200">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3>
      <p id="error-message" class="text-slate-500 text-sm md:text-base"></p>
      <button id="retry-btn" class="px-8 py-3 bg-white/10 text-white rounded-xl hover:bg-white/20 active:bg-white/30 transition-all font-medium touch-feedback">
        ãƒªãƒˆãƒ©ã‚¤
      </button>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center text-xs text-slate-600 py-4">
    <a href="https://github.com/Toshiki-Yasuda/pdf-slide-studio" target="_blank" rel="noopener noreferrer" class="hover:text-slate-400 transition-colors">
      PDF Slide Studio Pro
    </a>
    â€¢ OCR & Shape Detection â€¢ No Upload Required
  </footer>
  
</div>
```

  </div>

  <!-- Modal for Slide Preview -->

  <div id="slide-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="relative max-w-4xl w-full max-h-[90vh] bg-slate-900 rounded-2xl overflow-hidden">
      <button id="close-modal" class="absolute top-4 right-4 z-10 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all" aria-label="é–‰ã˜ã‚‹">
        <i data-lucide="x" class="w-5 h-5" aria-hidden="true"></i>
      </button>
      <button id="prev-slide" class="absolute left-4 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all" aria-label="å‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰">
        <i data-lucide="chevron-left" class="w-5 h-5" aria-hidden="true"></i>
      </button>
      <button id="next-slide" class="absolute right-4 top-1/2 -translate-y-1/2 z-10 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition-all" aria-label="æ¬¡ã®ã‚¹ãƒ©ã‚¤ãƒ‰">
        <i data-lucide="chevron-right" class="w-5 h-5" aria-hidden="true"></i>
      </button>
      <div class="p-4 overflow-auto max-h-[90vh]">
        <h2 id="modal-title" class="sr-only">ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <img id="modal-image" src="" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="w-full h-auto rounded-lg">
        <p id="modal-caption" class="text-center text-slate-400 text-sm mt-4"></p>
        <div id="modal-text" class="mt-4 p-4 bg-black/30 rounded-lg max-h-[200px] overflow-y-auto">
          <p class="text-xs text-slate-400 mb-2">OCRæŠ½å‡ºãƒ†ã‚­ã‚¹ãƒˆ:</p>
          <p id="modal-ocr-text" class="text-sm text-slate-300 whitespace-pre-wrap"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->

  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden px-6 py-3 bg-slate-800 border border-slate-700 text-white rounded-xl shadow-xl transition-all transform" role="status" aria-live="polite">
    <div class="flex items-center gap-3">
      <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-400" aria-hidden="true"></i>
      <span id="toast-message">å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ</span>
    </div>
  </div>

  <script>
    // ============================================
    // Initialize Libraries
    // ============================================
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ============================================
    // App State
    // ============================================
    const state = {
      file: null,
      images: [],
      zipBlob: null,
      status: 'idle',
      progress: { current: 0, total: 0, message: '', detail: '' },
      cancelRequested: false,
      currentModalSlide: 0,
      isExporting: false,
      selectedSlideIndex: null,
      ocrEnabled: true,
      shapeDetectionEnabled: true,
      ocrLanguage: 'jpn+eng',
      tesseractWorker: null
    };

    // ============================================
    // DOM Elements
    // ============================================
    const elements = {
      fileInput: document.getElementById('file-input'),
      uploadArea: document.getElementById('upload-area'),
      uploadButton: document.getElementById('upload-button'),
      processingArea: document.getElementById('processing-area'),
      editorArea: document.getElementById('editor-area'),
      errorArea: document.getElementById('error-area'),
      initStatus: document.getElementById('init-status'),
      headerContent: document.getElementById('header-content'),
      progressCircle: document.getElementById('progress-circle'),
      progressPercent: document.getElementById('progress-percent'),
      progressMessage: document.getElementById('progress-message'),
      progressDetail: document.getElementById('progress-detail'),
      cancelButton: document.getElementById('cancel-button'),
      fileName: document.getElementById('file-name'),
      slideCount: document.getElementById('slide-count'),
      slideGrid: document.getElementById('slide-grid'),
      ocrStatus: document.getElementById('ocr-status'),
      downloadZipBtn: document.getElementById('download-zip-btn'),
      downloadPptxBtn: document.getElementById('download-pptx-btn'),
      downloadGifBtn: document.getElementById('download-gif-btn'),
      downloadJsonBtn: document.getElementById('download-json-btn'),
      downloadTextBtn: document.getElementById('download-text-btn'),
      resetBtn: document.getElementById('reset-btn'),
      retryBtn: document.getElementById('retry-btn'),
      errorMessage: document.getElementById('error-message'),
      slideModal: document.getElementById('slide-modal'),
      closeModal: document.getElementById('close-modal'),
      prevSlide: document.getElementById('prev-slide'),
      nextSlide: document.getElementById('next-slide'),
      modalImage: document.getElementById('modal-image'),
      modalCaption: document.getElementById('modal-caption'),
      modalOcrText: document.getElementById('modal-ocr-text'),
      toast: document.getElementById('toast'),
      toastIcon: document.getElementById('toast-icon'),
      toastMessage: document.getElementById('toast-message'),
      // Settings
      ocrEnabled: document.getElementById('ocr-enabled'),
      shapeDetectionEnabled: document.getElementById('shape-detection-enabled'),
      ocrLanguage: document.getElementById('ocr-language'),
      // Tabs
      tabPreview: document.getElementById('tab-preview'),
      tabText: document.getElementById('tab-text'),
      tabShapes: document.getElementById('tab-shapes'),
      tabContentPreview: document.getElementById('tab-content-preview'),
      tabContentText: document.getElementById('tab-content-text'),
      tabContentShapes: document.getElementById('tab-content-shapes'),
      // Text Editor
      slideList: document.getElementById('slide-list'),
      textEditor: document.getElementById('text-editor'),
      textEditorTitle: document.getElementById('text-editor-title'),
      textConfidence: document.getElementById('text-confidence'),
      textCharCount: document.getElementById('text-char-count'),
      slidePreviewContainer: document.getElementById('slide-preview-container'),
      copyTextBtn: document.getElementById('copy-text-btn'),
      // Shape Editor
      shapeSlideList: document.getElementById('shape-slide-list'),
      shapePreviewContainer: document.getElementById('shape-preview-container'),
      shapePreviewTitle: document.getElementById('shape-preview-title'),
      shapeList: document.getElementById('shape-list'),
      shapeCount: document.getElementById('shape-count')
    };

    // ============================================
    // Initialize
    // ============================================
    lucide.createIcons();

    // Initialize OCR Worker
    async function initOCRWorker() {
      try {
        if (window.Tesseract) {
          elements.initStatus.innerHTML = `
            <i data-lucide="check-circle" class="w-3 h-3 text-green-400" aria-hidden="true"></i>
            <span>OCRã‚¨ãƒ³ã‚¸ãƒ³æº–å‚™å®Œäº†</span>
          `;
          lucide.createIcons();
          setTimeout(() => {
            elements.initStatus.classList.add('hidden');
          }, 2000);
        }
      } catch (err) {
        console.error('OCR init error:', err);
        elements.initStatus.innerHTML = `
          <i data-lucide="alert-circle" class="w-3 h-3 text-yellow-400" aria-hidden="true"></i>
          <span>OCRã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã§ã™</span>
        `;
        lucide.createIcons();
      }
    }
    initOCRWorker();

    // ============================================
    // OCR Processing
    // ============================================
    async function performOCR(imageDataUrl, language = 'jpn+eng') {
      if (!window.Tesseract || !state.ocrEnabled) {
        return { text: '', confidence: 0 };
      }
      
      try {
        const worker = await Tesseract.createWorker(language, 1, {
          logger: m => {
            if (m.status === 'recognizing text') {
              const progress = Math.round(m.progress * 100);
              elements.progressDetail.textContent = `OCRå‡¦ç†ä¸­... ${progress}%`;
            }
          }
        });
        
        const result = await worker.recognize(imageDataUrl);
        await worker.terminate();
        
        return { 
          text: result.data.text.trim(), 
          confidence: Math.round(result.data.confidence),
          words: result.data.words || []
        };
      } catch (err) {
        console.error('OCR Error:', err);
        return { text: '', confidence: 0, words: [] };
      }
    }

    // ============================================
    // Shape Detection (Enhanced)
    // ============================================
    function detectShapes(canvas) {
      if (!state.shapeDetectionEnabled) {
        return [];
      }
      
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      const shapes = [];
      
      // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
      const gray = new Uint8ClampedArray(width * height);
      for (let i = 0; i < data.length; i += 4) {
        gray[i / 4] = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
      }
      
      // Sobelã‚¨ãƒƒã‚¸æ¤œå‡º
      const edges = new Uint8ClampedArray(width * height);
      const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
      const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let gx = 0, gy = 0;
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const idx = (y + ky) * width + (x + kx);
              const kidx = (ky + 1) * 3 + (kx + 1);
              gx += gray[idx] * sobelX[kidx];
              gy += gray[idx] * sobelY[kidx];
            }
          }
          edges[y * width + x] = Math.min(255, Math.sqrt(gx * gx + gy * gy));
        }
      }
      
      // é€£çµæˆåˆ†åˆ†æã§å›³å½¢ã‚’æ¤œå‡º
      const visited = new Set();
      const threshold = 50;
      const minArea = 100;
      
      function floodFill(startX, startY) {
        const stack = [[startX, startY]];
        const region = [];
        let minX = startX, maxX = startX, minY = startY, maxY = startY;
        
        while (stack.length > 0 && region.length < 10000) {
          const [x, y] = stack.pop();
          const key = `${x},${y}`;
          
          if (visited.has(key) || x < 0 || x >= width || y < 0 || y >= height) continue;
          if (edges[y * width + x] < threshold) continue;
          
          visited.add(key);
          region.push([x, y]);
          
          minX = Math.min(minX, x);
          maxX = Math.max(maxX, x);
          minY = Math.min(minY, y);
          maxY = Math.max(maxY, y);
          
          // 8è¿‘å‚
          for (let dy = -1; dy <= 1; dy++) {
            for (let dx = -1; dx <= 1; dx++) {
              if (dx !== 0 || dy !== 0) {
                stack.push([x + dx, y + dy]);
              }
            }
          }
        }
        
        return { region, minX, maxX, minY, maxY };
      }
      
      // ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã§æ¤œå‡º
      for (let y = 5; y < height - 5; y += 15) {
        for (let x = 5; x < width - 5; x += 15) {
          if (visited.has(`${x},${y}`)) continue;
          if (edges[y * width + x] < threshold) continue;
          
          const { region, minX, maxX, minY, maxY } = floodFill(x, y);
          
          if (region.length >= minArea) {
            const shapeWidth = maxX - minX;
            const shapeHeight = maxY - minY;
            const area = region.length;
            const boundingArea = shapeWidth * shapeHeight;
            const fillRatio = area / boundingArea;
            const aspectRatio = shapeWidth / (shapeHeight || 1);
            
            // å½¢çŠ¶åˆ†é¡
            let type = 'rectangle';
            let color = '#3b82f6';
            
            if (aspectRatio > 0.8 && aspectRatio < 1.2 && fillRatio > 0.6) {
              type = 'circle';
              color = '#10b981';
            } else if (aspectRatio > 3 || aspectRatio < 0.33) {
              type = 'line';
              color = '#f59e0b';
            } else if (fillRatio < 0.3) {
              type = 'polygon';
              color = '#8b5cf6';
            }
            
            shapes.push({
              id: shapes.length,
              type,
              x: minX,
              y: minY,
              width: shapeWidth,
              height: shapeHeight,
              area: area,
              fillRatio: Math.round(fillRatio * 100),
              color,
              editable: true
            });
          }
        }
      }
      
      // ã‚µã‚¤ã‚ºã§ã‚½ãƒ¼ãƒˆï¼ˆå¤§ãã„é †ï¼‰
      shapes.sort((a, b) => b.area - a.area);
      
      // ä¸Šä½30å€‹ã«åˆ¶é™
      return shapes.slice(0, 30);
    }

    // ============================================
    // Event Listeners
    // ============================================
    elements.uploadButton.addEventListener('click', (e) => {
      e.preventDefault();
      elements.fileInput.click();
    });

    elements.uploadButton.addEventListener('touchend', (e) => {
      e.preventDefault();
      elements.fileInput.click();
    });

    elements.fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        // è¨­å®šã‚’å–å¾—
        state.ocrEnabled = elements.ocrEnabled.checked;
        state.shapeDetectionEnabled = elements.shapeDetectionEnabled.checked;
        state.ocrLanguage = elements.ocrLanguage.value;
        processFile(file);
      } else if (file) {
        showError('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚');
      }
    });

    // Drag and Drop
    elements.uploadButton.addEventListener('dragover', (e) => {
      e.preventDefault();
      elements.uploadButton.classList.add('bg-indigo-500/10');
    });

    elements.uploadButton.addEventListener('dragleave', (e) => {
      e.preventDefault();
      elements.uploadButton.classList.remove('bg-indigo-500/10');
    });

    elements.uploadButton.addEventListener('drop', (e) => {
      e.preventDefault();
      elements.uploadButton.classList.remove('bg-indigo-500/10');
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        state.ocrEnabled = elements.ocrEnabled.checked;
        state.shapeDetectionEnabled = elements.shapeDetectionEnabled.checked;
        state.ocrLanguage = elements.ocrLanguage.value;
        processFile(file);
      } else if (file) {
        showError('PDFãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚');
      }
    });

    elements.cancelButton.addEventListener('click', () => {
      state.cancelRequested = true;
      updateProgress(0, 0, 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­...', '');
    });

    elements.resetBtn.addEventListener('click', reset);
    elements.retryBtn.addEventListener('click', reset);

    // Download buttons
    elements.downloadZipBtn.addEventListener('click', downloadZip);
    elements.downloadPptxBtn.addEventListener('click', downloadPptx);
    elements.downloadGifBtn.addEventListener('click', downloadGif);
    elements.downloadJsonBtn.addEventListener('click', downloadJson);
    elements.downloadTextBtn.addEventListener('click', downloadAllText);

    // Modal controls
    elements.closeModal.addEventListener('click', closeModal);
    elements.prevSlide.addEventListener('click', () => navigateSlide(-1));
    elements.nextSlide.addEventListener('click', () => navigateSlide(1));
    elements.slideModal.addEventListener('click', (e) => {
      if (e.target === elements.slideModal) closeModal();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!elements.slideModal.classList.contains('hidden')) {
        if (e.key === 'Escape') closeModal();
        if (e.key === 'ArrowLeft') navigateSlide(-1);
        if (e.key === 'ArrowRight') navigateSlide(1);
      }
    });

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.id.replace('tab-', '')));
    });

    // Text editor
    elements.textEditor.addEventListener('input', (e) => {
      if (state.selectedSlideIndex !== null) {
        state.images[state.selectedSlideIndex].text = e.target.value;
        elements.textCharCount.textContent = `${e.target.value.length} æ–‡å­—`;
      }
    });

    elements.copyTextBtn.addEventListener('click', () => {
      if (elements.textEditor.value) {
        navigator.clipboard.writeText(elements.textEditor.value);
        showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
      }
    });

    // ============================================
    // Process PDF File
    // ============================================
    async function processFile(file) {
      state.file = file;
      state.images = [];
      state.zipBlob = null;
      state.cancelRequested = false;
      state.selectedSlideIndex = null;
      
      showProcessing();
      updateProgress(0, 0, 'PDFã‚’è§£æä¸­...', '');

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const totalPages = pdf.numPages;

        const zip = new JSZip();
        const imageFolder = zip.folder('images');
        const textFolder = zip.folder('text');

        let totalOcrTime = 0;

        for (let i = 1; i <= totalPages; i++) {
          if (state.cancelRequested) {
            reset();
            showToast('å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'info');
            return;
          }

          updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...');

          const page = await pdf.getPage(i);
          const scale = 2.0;
          const viewport = page.getViewport({ scale });

          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.width = viewport.width;
          canvas.height = viewport.height;

          await page.render({ canvasContext: context, viewport }).promise;

          const dataUrl = canvas.toDataURL('image/png');
          const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

          // OCRå‡¦ç†
          let ocrResult = { text: '', confidence: 0, words: [] };
          if (state.ocrEnabled) {
            updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'OCRå‡¦ç†ä¸­...');
            const ocrStart = Date.now();
            ocrResult = await performOCR(dataUrl, state.ocrLanguage);
            totalOcrTime += Date.now() - ocrStart;
          }

          // å›³å½¢æ¤œå‡º
          let shapes = [];
          if (state.shapeDetectionEnabled) {
            updateProgress(i, totalPages, `ã‚¹ãƒ©ã‚¤ãƒ‰ ${i}/${totalPages}`, 'å›³å½¢æ¤œå‡ºä¸­...');
            shapes = detectShapes(canvas);
          }

          const slideData = {
            id: i,
            dataUrl,
            blob,
            width: viewport.width,
            height: viewport.height,
            name: `slide_${String(i).padStart(2, '0')}.png`,
            text: ocrResult.text,
            confidence: ocrResult.confidence,
            words: ocrResult.words,
            shapes: shapes
          };

          state.images.push(slideData);

          // ZIPã«è¿½åŠ 
          imageFolder.file(slideData.name, blob);
          if (ocrResult.text) {
            textFolder.file(`slide_${String(i).padStart(2, '0')}.txt`, ocrResult.text);
          }

          // ãƒ¡ãƒ¢ãƒªè§£æ”¾
          canvas.width = 0;
          canvas.height = 0;

          await new Promise(r => setTimeout(r, 30));
        }

        if (state.cancelRequested) {
          reset();
          showToast('å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'info');
          return;
        }

        updateProgress(totalPages, totalPages, 'ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä½œæˆä¸­...', '');
        state.zipBlob = await zip.generateAsync({ type: 'blob' });

        showEditor();
        
        const ocrInfo = state.ocrEnabled ? ` (OCR: ${Math.round(totalOcrTime / 1000)}ç§’)` : '';
        showToast(`${totalPages}æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‡¦ç†ã—ã¾ã—ãŸ${ocrInfo}`, 'success');
      } catch (err) {
        console.error('Processing error:', err);
        
        let errorMsg = 'PDFã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
        if (err.name === 'PasswordException') {
          errorMsg = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚ŒãŸPDFã¯å‡¦ç†ã§ãã¾ã›ã‚“ã€‚';
        } else if (err.name === 'InvalidPDFException') {
          errorMsg = 'ç„¡åŠ¹ãªPDFãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚';
        }
        
        showError(errorMsg);
      }
    }

    // ============================================
    // UI State Functions
    // ============================================
    function showProcessing() {
      elements.uploadArea.classList.add('hidden');
      elements.processingArea.classList.remove('hidden');
      elements.processingArea.style.display = 'flex';
      elements.editorArea.classList.add('hidden');
      elements.errorArea.classList.add('hidden');
      elements.headerContent.classList.add('hidden');
    }

    function showEditor() {
      elements.uploadArea.classList.add('hidden');
      elements.processingArea.classList.add('hidden');
      elements.processingArea.style.display = 'none';
      elements.editorArea.classList.remove('hidden');
      elements.errorArea.classList.add('hidden');
      elements.headerContent.classList.add('hidden');

      elements.fileName.textContent = state.file.name;
      elements.slideCount.textContent = `${state.images.length} ã‚¹ãƒ©ã‚¤ãƒ‰`;
      
      const totalChars = state.images.reduce((sum, img) => sum + (img.text?.length || 0), 0);
      const totalShapes = state.images.reduce((sum, img) => sum + (img.shapes?.length || 0), 0);
      elements.ocrStatus.textContent = state.ocrEnabled 
        ? `OCR: ${totalChars.toLocaleString()}æ–‡å­— / å›³å½¢: ${totalShapes}å€‹`
        : '';

      renderSlideGrid();
      renderSlideList();
      renderShapeSlideList();
    }

    function showError(message) {
      elements.uploadArea.classList.add('hidden');
      elements.processingArea.classList.add('hidden');
      elements.processingArea.style.display = 'none';
      elements.editorArea.classList.add('hidden');
      elements.errorArea.classList.remove('hidden');
      elements.headerContent.classList.remove('hidden');
      elements.errorMessage.textContent = message;
    }

    function reset() {
      state.file = null;
      state.images = [];
      state.zipBlob = null;
      state.cancelRequested = false;
      state.selectedSlideIndex = null;
      elements.fileInput.value = '';

      elements.uploadArea.classList.remove('hidden');
      elements.processingArea.classList.add('hidden');
      elements.processingArea.style.display = 'none';
      elements.editorArea.classList.add('hidden');
      elements.errorArea.classList.add('hidden');
      elements.headerContent.classList.remove('hidden');
      elements.slideGrid.innerHTML = '';
      elements.slideList.innerHTML = '';
      elements.shapeSlideList.innerHTML = '';
      
      switchTab('preview');
    }

    function updateProgress(current, total, message, detail) {
      const percent = total > 0 ? Math.round((current / total) * 100) : 0;
      const circumference = 289.02;
      const dashArray = `${(circumference * percent) / 100} ${circumference}`;

      elements.progressCircle.setAttribute('stroke-dasharray', dashArray);
      elements.progressPercent.textContent = `${percent}%`;
      elements.progressMessage.textContent = message;
      elements.progressDetail.textContent = detail || '';
    }

    // ============================================
    // Tab Functions
    // ============================================
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.add('text-slate-400');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });

      const activeTab = document.getElementById(`tab-${tabName}`);
      const activeContent = document.getElementById(`tab-content-${tabName}`);
      
      if (activeTab && activeContent) {
        activeTab.classList.add('tab-active');
        activeTab.classList.remove('text-slate-400');
        activeContent.classList.remove('hidden');
      }
    }

    // ============================================
    // Render Functions
    // ============================================
    function renderSlideGrid() {
      elements.slideGrid.innerHTML = '';

      state.images.forEach((img, idx) => {
        const slideEl = document.createElement('div');
        slideEl.className = 'group relative bg-slate-800/50 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-cyan-500/50 transition-all touch-feedback';
        slideEl.setAttribute('role', 'listitem');
        
        const hasText = img.text && img.text.length > 0;
        const hasShapes = img.shapes && img.shapes.length > 0;
        
        slideEl.innerHTML = `
          <img src="${img.dataUrl}" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}" class="w-full h-auto" loading="lazy">
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/30 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
            <i data-lucide="maximize-2" class="w-6 h-6 text-white" aria-hidden="true"></i>
          </div>
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
            <div class="flex items-center justify-between">
              <span class="text-xs text-white font-medium">${idx + 1}</span>
              <div class="flex gap-1">
                ${hasText ? '<span class="w-2 h-2 bg-green-400 rounded-full" title="ãƒ†ã‚­ã‚¹ãƒˆã‚ã‚Š"></span>' : ''}
                ${hasShapes ? '<span class="w-2 h-2 bg-blue-400 rounded-full" title="å›³å½¢ã‚ã‚Š"></span>' : ''}
              </div>
            </div>
          </div>
        `;

        slideEl.addEventListener('click', () => openSlideModal(idx));
        elements.slideGrid.appendChild(slideEl);
      });

      lucide.createIcons();
    }

    function renderSlideList() {
      elements.slideList.innerHTML = '';

      state.images.forEach((img, idx) => {
        const btn = document.createElement('button');
        btn.className = `w-full p-3 rounded-lg text-left transition-all ${
          state.selectedSlideIndex === idx 
            ? 'bg-cyan-600 text-white' 
            : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'
        }`;
        btn.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="font-medium">ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}</span>
            <span class="text-xs opacity-70">${img.text?.length || 0}æ–‡å­—</span>
          </div>
          <p class="text-xs mt-1 opacity-70 line-clamp-2">${img.text?.slice(0, 50) || 'ãƒ†ã‚­ã‚¹ãƒˆãªã—'}...</p>
        `;
        btn.addEventListener('click', () => selectSlideForTextEdit(idx));
        elements.slideList.appendChild(btn);
      });
    }

    function renderShapeSlideList() {
      elements.shapeSlideList.innerHTML = '';

      state.images.forEach((img, idx) => {
        const btn = document.createElement('button');
        btn.className = `w-full p-3 rounded-lg text-left transition-all ${
          state.selectedSlideIndex === idx 
            ? 'bg-cyan-600 text-white' 
            : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'
        }`;
        btn.innerHTML = `
          <div class="flex items-center justify-between">
            <span class="font-medium">ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}</span>
            <span class="text-xs opacity-70">${img.shapes?.length || 0}å€‹</span>
          </div>
        `;
        btn.addEventListener('click', () => selectSlideForShapeView(idx));
        elements.shapeSlideList.appendChild(btn);
      });
    }

    function selectSlideForTextEdit(idx) {
      state.selectedSlideIndex = idx;
      const img = state.images[idx];
      
      elements.textEditorTitle.textContent = `ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}`;
      elements.textEditor.value = img.text || '';
      elements.textEditor.disabled = false;
      elements.copyTextBtn.disabled = false;
      elements.textCharCount.textContent = `${(img.text?.length || 0)} æ–‡å­—`;
      elements.textConfidence.textContent = img.confidence ? `ä¿¡é ¼åº¦: ${img.confidence}%` : '';
      
      elements.slidePreviewContainer.innerHTML = `
        <img src="${img.dataUrl}" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}" class="max-w-full max-h-[200px] mx-auto">
      `;
      
      renderSlideList();
    }

    function selectSlideForShapeView(idx) {
      state.selectedSlideIndex = idx;
      const img = state.images[idx];
      
      elements.shapePreviewTitle.textContent = `ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1} ã®å›³å½¢`;
      elements.shapeCount.textContent = `(${img.shapes?.length || 0})`;
      
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å›³å½¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
      const scaleRatio = 400 / img.width;
      const displayHeight = img.height * scaleRatio;
      
      let overlayHtml = `
        <div class="relative" style="width: 400px; max-width: 100%;">
          <img src="${img.dataUrl}" alt="ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1}" class="w-full h-auto">
      `;
      
      if (img.shapes) {
        img.shapes.forEach((shape, i) => {
          const left = (shape.x / img.width) * 100;
          const top = (shape.y / img.height) * 100;
          const width = (shape.width / img.width) * 100;
          const height = (shape.height / img.height) * 100;
          
          overlayHtml += `
            <div class="shape-overlay" style="
              left: ${left}%;
              top: ${top}%;
              width: ${width}%;
              height: ${height}%;
              border-color: ${shape.color};
              ${shape.type === 'circle' ? 'border-radius: 50%;' : ''}
            " title="${shape.type} #${i + 1}"></div>
          `;
        });
      }
      
      overlayHtml += '</div>';
      elements.shapePreviewContainer.innerHTML = overlayHtml;
      
      // å›³å½¢ãƒªã‚¹ãƒˆ
      if (img.shapes && img.shapes.length > 0) {
        elements.shapeList.innerHTML = img.shapes.map((shape, i) => `
          <div class="flex items-center gap-3 p-2 bg-slate-900/50 rounded-lg">
            <div class="w-4 h-4 rounded ${shape.type === 'circle' ? 'rounded-full' : ''}" style="background-color: ${shape.color}"></div>
            <div class="flex-1">
              <span class="text-sm text-slate-200">${shape.type}</span>
              <span class="text-xs text-slate-500 ml-2">${shape.width}Ã—${shape.height}px</span>
            </div>
            <span class="text-xs text-slate-500">å……å¡«ç‡: ${shape.fillRatio}%</span>
          </div>
        `).join('');
      } else {
        elements.shapeList.innerHTML = '<p class="text-slate-500 text-sm">å›³å½¢ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</p>';
      }
      
      renderShapeSlideList();
    }

    // ============================================
    // Modal Functions
    // ============================================
    function openSlideModal(idx) {
      state.currentModalSlide = idx;
      updateModalContent();
      elements.slideModal.classList.remove('hidden');
      elements.slideModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      elements.slideModal.classList.add('hidden');
      elements.slideModal.style.display = 'none';
      document.body.style.overflow = '';
    }

    function navigateSlide(direction) {
      const newIndex = state.currentModalSlide + direction;
      if (newIndex >= 0 && newIndex < state.images.length) {
        state.currentModalSlide = newIndex;
        updateModalContent();
      }
    }

    function updateModalContent() {
      const img = state.images[state.currentModalSlide];
      elements.modalImage.src = img.dataUrl;
      elements.modalCaption.textContent = `ã‚¹ãƒ©ã‚¤ãƒ‰ ${state.currentModalSlide + 1} / ${state.images.length}`;
      elements.modalOcrText.textContent = img.text || '(ãƒ†ã‚­ã‚¹ãƒˆãªã—)';
      
      elements.prevSlide.style.display = state.currentModalSlide > 0 ? 'flex' : 'none';
      elements.nextSlide.style.display = state.currentModalSlide < state.images.length - 1 ? 'flex' : 'none';
    }

    // ============================================
    // Toast Notification
    // ============================================
    function showToast(message, type = 'success') {
      elements.toastMessage.textContent = message;
      
      const iconName = type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info';
      const iconColor = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-blue-400';
      elements.toastIcon.setAttribute('data-lucide', iconName);
      elements.toastIcon.className = `w-5 h-5 ${iconColor}`;
      lucide.createIcons();
      
      elements.toast.classList.remove('hidden');
      
      setTimeout(() => {
        elements.toast.classList.add('hidden');
      }, 3000);
    }

    // ============================================
    // Download Functions
    // ============================================
    function downloadFile(blob, filename) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function setExportButtonsDisabled(disabled) {
      state.isExporting = disabled;
      elements.downloadZipBtn.disabled = disabled;
      elements.downloadPptxBtn.disabled = disabled;
      elements.downloadGifBtn.disabled = disabled;
      elements.downloadJsonBtn.disabled = disabled;
      elements.downloadTextBtn.disabled = disabled;
    }

    function downloadZip() {
      if (state.zipBlob && state.file) {
        const filename = state.file.name.replace('.pdf', '') + '_slides.zip';
        downloadFile(state.zipBlob, filename);
        showToast('ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
      }
    }

    async function downloadPptx() {
      if (!state.images.length || state.isExporting) return;

      try {
        setExportButtonsDisabled(true);
        showToast('PPTXä½œæˆä¸­...', 'info');

        const pptx = new PptxGenJS();
        pptx.defineLayout({ name: 'CUSTOM', width: 10, height: 5.625 });
        pptx.layout = 'CUSTOM';

        for (const img of state.images) {
          const slide = pptx.addSlide();
          slide.addImage({
            data: img.dataUrl,
            x: 0,
            y: 0,
            w: '100%',
            h: '100%'
          });
          
          // ãƒãƒ¼ãƒˆã«OCRãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
          if (img.text) {
            slide.addNotes(img.text);
          }
        }

        const filename = state.file.name.replace('.pdf', '') + '.pptx';
        await pptx.writeFile({ fileName: filename });
        showToast('PPTXã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆãƒãƒ¼ãƒˆã«OCRãƒ†ã‚­ã‚¹ãƒˆä»˜ãï¼‰', 'success');
      } catch (err) {
        console.error('PPTX export error:', err);
        showToast('PPTXä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      } finally {
        setExportButtonsDisabled(false);
      }
    }

    async function downloadGif() {
      if (!state.images.length || state.isExporting) return;

      try {
        setExportButtonsDisabled(true);
        showToast('GIFä½œæˆä¸­...', 'info');

        if (!window.GIF) {
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        const gif = new GIF({
          workers: 2,
          quality: 10,
          workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
        });

        for (const img of state.images) {
          const image = new Image();
          image.src = img.dataUrl;
          await new Promise(resolve => { image.onload = resolve; });
          gif.addFrame(image, { delay: 1000 });
        }

        gif.on('finished', (blob) => {
          const filename = state.file.name.replace('.pdf', '') + '.gif';
          downloadFile(blob, filename);
          showToast('GIFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
          setExportButtonsDisabled(false);
        });

        gif.render();
      } catch (err) {
        console.error('GIF export error:', err);
        showToast('GIFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        setExportButtonsDisabled(false);
      }
    }

    function downloadJson() {
      if (!state.images.length) return;

      const data = {
        filename: state.file.name,
        processedAt: new Date().toISOString(),
        settings: {
          ocrEnabled: state.ocrEnabled,
          ocrLanguage: state.ocrLanguage,
          shapeDetectionEnabled: state.shapeDetectionEnabled
        },
        slides: state.images.map((img, idx) => ({
          slideNumber: idx + 1,
          width: img.width,
          height: img.height,
          text: img.text || '',
          confidence: img.confidence || 0,
          shapes: img.shapes || []
        }))
      };

      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const filename = state.file.name.replace('.pdf', '') + '_data.json';
      downloadFile(blob, filename);
      showToast('JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    }

    function downloadAllText() {
      if (!state.images.length) return;

      const allText = state.images.map((img, idx) => {
        return `===== ã‚¹ãƒ©ã‚¤ãƒ‰ ${idx + 1} =====\n\n${img.text || '(ãƒ†ã‚­ã‚¹ãƒˆãªã—)'}\n`;
      }).join('\n\n');

      const blob = new Blob([allText], { type: 'text/plain; charset=utf-8' });
      const filename = state.file.name.replace('.pdf', '') + '_all_text.txt';
      downloadFile(blob, filename);
      showToast('ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
    }
  </script>

</body>
</html>
